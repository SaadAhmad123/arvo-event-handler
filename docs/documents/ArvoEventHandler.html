<!DOCTYPE html><html class="default" lang="en"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>ArvoEventHandler | arvo-event-handler</title><meta name="description" content="Documentation for arvo-event-handler"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><link rel="stylesheet" href="../assets/typedoc-github-style.css"/></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base=".."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">arvo-event-handler</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">arvo-event-handler</a></li><li><a href="ArvoEventHandler.html">ArvoEventHandler</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="md:arvoeventhandler---implementation-of-a-reliable-event-driven-system" class="tsd-anchor"></a><h1 class="tsd-anchor-link">ArvoEventHandler - Implementation of a Reliable Event-Driven System<a href="#md:arvoeventhandler---implementation-of-a-reliable-event-driven-system" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Event-driven architectures present distinct challenges in reliability and maintainability. Services must communicate dependably, manage errors effectively, and evolve without disrupting existing clients. The¬†<code>ArvoEventHandler</code>¬†addresses these challenges by transforming¬†<code>ArvoContract</code>¬†contracts into actively enforced rules for service communication. While¬†<code>ArvoContract</code>¬†defines a service's behaviour from the broader system's perspective,¬†<code>ArvoEventHandler</code>¬†binds with a contract to bring the service's functionality to life.</p>
<a id="md:getting-started-with-arvoeventhandler" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Getting Started with <code>ArvoEventHandler</code><a href="#md:getting-started-with-arvoeventhandler" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>This section provides a hands-on introduction to building your first event handler with ArvoEventHandler. You'll learn how to transform an ArvoContract into a working service that processes events reliably.</p>
<a id="md:your-first-event-handler" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Your First Event Handler<a href="#md:your-first-event-handler" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Let's build on the user registration contract from the ArvoContract guide and create a working event handler.</p>
<a id="md:step-1-set-up-your-contract-and-dependencies" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Step 1: Set Up Your Contract and Dependencies<a href="#md:step-1-set-up-your-contract-and-dependencies" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>First, let's establish our contract and create some mock dependencies to simulate real-world services:</p>
<pre><code class="typescript"><span class="hl-5">// contracts/user-registration.ts</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoContract</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">z</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;zod&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userRegistrationContract</span><span class="hl-1"> = </span><span class="hl-0">createArvoContract</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">uri:</span><span class="hl-1"> </span><span class="hl-2">&#39;#/services/user/registration&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.user.register&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">versions:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">accepts:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">().</span><span class="hl-0">email</span><span class="hl-1">(</span><span class="hl-2">&#39;Must be a valid email&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">                </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">().</span><span class="hl-0">min</span><span class="hl-1">(</span><span class="hl-8">3</span><span class="hl-1">, </span><span class="hl-2">&#39;Username must be at least 3 characters&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">                </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">().</span><span class="hl-0">min</span><span class="hl-1">(</span><span class="hl-8">8</span><span class="hl-1">, </span><span class="hl-2">&#39;Password must be at least 8 characters&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">            }),</span><br/><span class="hl-1">            </span><span class="hl-4">emits:</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-2">&#39;evt.user.registered&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                    </span><span class="hl-4">user_id:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">                    </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">                    </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">                    </span><span class="hl-4">created_at:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">().</span><span class="hl-0">datetime</span><span class="hl-1">(),</span><br/><span class="hl-1">                }),</span><br/><span class="hl-1">                </span><span class="hl-2">&#39;evt.user.registration.failed&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                    </span><span class="hl-4">reason:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">                    </span><span class="hl-4">error_code:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">enum</span><span class="hl-1">([</span><span class="hl-2">&#39;EMAIL_EXISTS&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;USERNAME_TAKEN&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;INVALID_INPUT&#39;</span><span class="hl-1">]),</span><br/><span class="hl-1">                })</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>Let's create a mock data for demostation purposes in <code>services/database.ts</code></p>
<pre><code class="typescript"><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-6">class</span><span class="hl-1"> </span><span class="hl-9">UserDatabase</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">private</span><span class="hl-1"> </span><span class="hl-4">emails</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Set</span><span class="hl-1">&lt;</span><span class="hl-9">string</span><span class="hl-1">&gt;();</span><br/><span class="hl-1">    </span><span class="hl-6">private</span><span class="hl-1"> </span><span class="hl-4">usernames</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Set</span><span class="hl-1">&lt;</span><span class="hl-9">string</span><span class="hl-1">&gt;();</span><br/><br/><span class="hl-1">    </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">emailExists</span><span class="hl-1">(</span><span class="hl-4">email</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">): </span><span class="hl-9">Promise</span><span class="hl-1">&lt;</span><span class="hl-9">boolean</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">emails</span><span class="hl-1">.</span><span class="hl-0">has</span><span class="hl-1">(</span><span class="hl-4">email</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">usernameExists</span><span class="hl-1">(</span><span class="hl-4">username</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">): </span><span class="hl-9">Promise</span><span class="hl-1">&lt;</span><span class="hl-9">boolean</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">usernames</span><span class="hl-1">.</span><span class="hl-0">has</span><span class="hl-1">(</span><span class="hl-4">username</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-0">createUser</span><span class="hl-1">(</span><span class="hl-4">email</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">, </span><span class="hl-4">username</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">, </span><span class="hl-4">password</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">): </span><span class="hl-9">Promise</span><span class="hl-1">&lt;</span><span class="hl-9">string</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">        </span><span class="hl-5">// Simulate async database operation</span><br/><span class="hl-1">        </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-9">Promise</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">setTimeout</span><span class="hl-1">(</span><span class="hl-4">resolve</span><span class="hl-1">, </span><span class="hl-8">10</span><span class="hl-1">));</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">emails</span><span class="hl-1">.</span><span class="hl-0">add</span><span class="hl-1">(</span><span class="hl-4">email</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-6">this</span><span class="hl-1">.</span><span class="hl-4">usernames</span><span class="hl-1">.</span><span class="hl-0">add</span><span class="hl-1">(</span><span class="hl-4">username</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-2">`user_</span><span class="hl-6">${</span><span class="hl-4">Date</span><span class="hl-10">.</span><span class="hl-0">now</span><span class="hl-10">()</span><span class="hl-6">}</span><span class="hl-2">_</span><span class="hl-6">${</span><span class="hl-4">Math</span><span class="hl-10">.</span><span class="hl-0">random</span><span class="hl-10">().</span><span class="hl-0">toString</span><span class="hl-10">(</span><span class="hl-8">36</span><span class="hl-10">).</span><span class="hl-0">substr</span><span class="hl-10">(</span><span class="hl-8">2</span><span class="hl-10">, </span><span class="hl-8">9</span><span class="hl-10">)</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<a id="md:step-2-create-your-event-handler" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Step 2: Create Your Event Handler<a href="#md:step-2-create-your-event-handler" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Now let's create the actual event handler using the factory pattern in <code>handlers/user-registration-handler.ts</code>:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoEventHandler</span><span class="hl-1">, </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-4">EventHandlerFactory</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-event-handler&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">logToSpan</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">userRegistrationContract</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../contracts/user-registration&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-3">type</span><span class="hl-1"> { </span><span class="hl-4">UserDatabase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../services/database&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-9">HandlerDependencies</span><span class="hl-1"> = {</span><br/><span class="hl-1">    </span><span class="hl-4">database</span><span class="hl-1">: </span><span class="hl-9">UserDatabase</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Create the handler factory - this is the recommended pattern</span><br/><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">userRegistrationHandlerFactory</span><span class="hl-1">: </span><span class="hl-9">EventHandlerFactory</span><span class="hl-1">&lt;</span><span class="hl-9">HandlerDependencies</span><span class="hl-1">&gt; = ({</span><br/><span class="hl-1">    </span><span class="hl-4">database</span><br/><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">contract:</span><span class="hl-1"> </span><span class="hl-4">userRegistrationContract</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">executionunits:</span><span class="hl-1"> </span><span class="hl-8">0.001</span><span class="hl-1">, </span><span class="hl-5">// Cost per execution (business-defined)</span><br/><span class="hl-1">  </span><span class="hl-4">handler:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({ </span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">source</span><span class="hl-1">, </span><span class="hl-4">span</span><span class="hl-1"> }) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`Processing user registration for </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">email</span><span class="hl-6">}</span><span class="hl-2">`</span><br/><span class="hl-1">      }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Check if email already exists</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">.</span><span class="hl-0">emailExists</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">email</span><span class="hl-1">)) {</span><br/><span class="hl-1">        </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">          </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;WARN&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`Registration failed: Email </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">email</span><span class="hl-6">}</span><span class="hl-2"> already exists`</span><br/><span class="hl-1">        }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.user.registration.failed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">reason:</span><span class="hl-1"> </span><span class="hl-2">&#39;Email address already exists in the system&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">error_code:</span><span class="hl-1"> </span><span class="hl-2">&#39;EMAIL_EXISTS&#39;</span><br/><span class="hl-1">          }</span><br/><span class="hl-1">        };</span><br/><span class="hl-1">      }</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Check if username already exists</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">.</span><span class="hl-0">usernameExists</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1">)) {</span><br/><span class="hl-1">        </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">          </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;WARN&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`Registration failed: Username </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">username</span><span class="hl-6">}</span><span class="hl-2"> already taken`</span><br/><span class="hl-1">        }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.user.registration.failed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">reason:</span><span class="hl-1"> </span><span class="hl-2">&#39;Username already taken&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">error_code:</span><span class="hl-1"> </span><span class="hl-2">&#39;USERNAME_TAKEN&#39;</span><br/><span class="hl-1">          }</span><br/><span class="hl-1">        };</span><br/><span class="hl-1">      }</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Create the user</span><br/><span class="hl-1">      </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userId</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">.</span><span class="hl-0">createUser</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">email</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">password</span><br/><span class="hl-1">      );</span><br/><br/><span class="hl-1">      </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`User </span><span class="hl-6">${</span><span class="hl-4">userId</span><span class="hl-6">}</span><span class="hl-2"> created successfully`</span><br/><span class="hl-1">      }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Return success event</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.user.registered&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-4">user_id:</span><span class="hl-1"> </span><span class="hl-4">userId</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">email</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">created_at:</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">().</span><span class="hl-0">toISOString</span><span class="hl-1">()</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      };</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="md:step-3-put-it-all-together" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Step 3: Put It All Together<a href="#md:step-3-put-it-all-together" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Let's create a complete example that shows how to use your event handler in <code>examples/complete-user-service.ts</code>:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoEventFactory</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">userRegistrationContract</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../contracts/user-registration&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">userRegistrationHandlerFactory</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../handlers/user-registration-handler&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">UserDatabase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../services/database&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">function</span><span class="hl-1"> </span><span class="hl-0">runUserRegistrationDemo</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-5">// Set up dependencies</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">database</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">UserDatabase</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Create the handler instance with dependencies</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">handler</span><span class="hl-1"> = </span><span class="hl-0">userRegistrationHandlerFactory</span><span class="hl-1">({ </span><span class="hl-4">database</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-5">// Create an event factory for testing</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">eventFactory</span><span class="hl-1"> = </span><span class="hl-0">createArvoEventFactory</span><span class="hl-1">(</span><span class="hl-4">userRegistrationContract</span><span class="hl-1">.</span><span class="hl-0">version</span><span class="hl-1">(</span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-1">));</span><br/><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;=== User Registration Service Demo ===</span><span class="hl-11">\n</span><span class="hl-2">&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Test 1: Successful registration</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;üìù Test 1: Successful user registration&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">successEvent</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.web.frontend&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;john.doe@example.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;johndoe&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;securepassword123&#39;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">successResult</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">successEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`‚úÖ Result: </span><span class="hl-6">${</span><span class="hl-4">successResult</span><span class="hl-10">.</span><span class="hl-4">events</span><span class="hl-10">[</span><span class="hl-8">0</span><span class="hl-10">].</span><span class="hl-4">type</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`üìã Data:`</span><span class="hl-1">, </span><span class="hl-4">successResult</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">data</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Test 2: Duplicate email</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;üìù Test 2: Duplicate email registration&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">duplicateEmailEvent</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.web.frontend&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;john.doe@example.com&#39;</span><span class="hl-1">, </span><span class="hl-5">// Same email as above</span><br/><span class="hl-1">            </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;anotherjohn&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;anotherpassword123&#39;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">duplicateResult</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">duplicateEmailEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`‚ùå Result: </span><span class="hl-6">${</span><span class="hl-4">duplicateResult</span><span class="hl-10">.</span><span class="hl-4">events</span><span class="hl-10">[</span><span class="hl-8">0</span><span class="hl-10">].</span><span class="hl-4">type</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`üìã Data:`</span><span class="hl-1">, </span><span class="hl-4">duplicateResult</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">data</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Test 3: Duplicate username</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;üìù Test 3: Duplicate username registration&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">duplicateUsernameEvent</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.web.frontend&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;jane.doe@example.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;johndoe&#39;</span><span class="hl-1">, </span><span class="hl-5">// Same username as first test</span><br/><span class="hl-1">            </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;janepassword123&#39;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">duplicateUsernameResult</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">duplicateUsernameEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`‚ùå Result: </span><span class="hl-6">${</span><span class="hl-4">duplicateUsernameResult</span><span class="hl-10">.</span><span class="hl-4">events</span><span class="hl-10">[</span><span class="hl-8">0</span><span class="hl-10">].</span><span class="hl-4">type</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`üìã Data:`</span><span class="hl-1">, </span><span class="hl-4">duplicateUsernameResult</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">data</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Test 4: Runtime error handling</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;üìù Test 4: Runtime error handling&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Create an event with invalid data to trigger validation</span><br/><span class="hl-1">        </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">invalidEvent</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">            </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.web.frontend&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;not-an-email&#39;</span><span class="hl-1">, </span><span class="hl-5">// Invalid email</span><br/><span class="hl-1">                </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;ab&#39;</span><span class="hl-1">, </span><span class="hl-5">// Too short</span><br/><span class="hl-1">                </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;123&#39;</span><span class="hl-1"> </span><span class="hl-5">// Too short</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">invalidEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    } </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`üí• Caught validation error: </span><span class="hl-6">${</span><span class="hl-4">error</span><span class="hl-10">.</span><span class="hl-4">message</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Run the demo</span><br/><span class="hl-0">runUserRegistrationDemo</span><span class="hl-1">().</span><span class="hl-0">catch</span><span class="hl-1">(</span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-4">error</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="md:step-4-run-your-service" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Step 4: Run Your Service<a href="#md:step-4-run-your-service" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="bash"><span class="hl-0">npx</span><span class="hl-1"> </span><span class="hl-2">tsx</span><span class="hl-1"> </span><span class="hl-2">examples/complete-user-service.ts</span>
</code><button type="button">Copy</button></pre>

<p>You should see output showing successful registrations, business logic errors (like duplicate emails), and validation errors being handled appropriately.</p>
<a id="md:advanced-patterns" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Advanced Patterns<a href="#md:advanced-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="md:handling-multiple-versions" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Handling Multiple Versions<a href="#md:handling-multiple-versions" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>As your service evolves, you'll need to support multiple contract versions:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">handlerFactory</span><span class="hl-1">: </span><span class="hl-9">EventHandlerFactory</span><span class="hl-1">&lt;</span><span class="hl-9">HandlerDependencies</span><span class="hl-1">&gt; = ({ </span><span class="hl-4">database</span><span class="hl-1"> }) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">    </span><span class="hl-0">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">contract:</span><span class="hl-1"> </span><span class="hl-4">userRegistrationContract</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">executionunits:</span><span class="hl-1"> </span><span class="hl-8">0.001</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">handler:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({ </span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">span</span><span class="hl-1"> }) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-5">// Original implementation</span><br/><span class="hl-1">                </span><span class="hl-0">logToSpan</span><span class="hl-1">({ </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">, </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">&#39;Processing v1.0.0 registration&#39;</span><span class="hl-1"> }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><span class="hl-1">                </span><span class="hl-5">// ... implementation</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">            </span><span class="hl-2">&#39;2.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({ </span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">span</span><span class="hl-1"> }) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-5">// Enhanced implementation with new features</span><br/><span class="hl-1">                </span><span class="hl-0">logToSpan</span><span class="hl-1">({ </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">, </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">&#39;Processing v2.0.0 registration with enhanced validation&#39;</span><span class="hl-1"> }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><span class="hl-1">                </span><span class="hl-5">// ... enhanced implementation</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span>
</code><button type="button">Copy</button></pre>

<a id="md:error-handling-strategy" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Error Handling Strategy<a href="#md:error-handling-strategy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>ArvoEventHandler distinguishes between different types of issues:</p>
<pre><code class="typescript"><span class="hl-5">// Business logic errors - return as events</span><br/><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.user.registration.failed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">data:</span><span class="hl-1"> { </span><span class="hl-4">reason:</span><span class="hl-1"> </span><span class="hl-2">&#39;Email exists&#39;</span><span class="hl-1">, </span><span class="hl-4">error_code:</span><span class="hl-1"> </span><span class="hl-2">&#39;EMAIL_EXISTS&#39;</span><span class="hl-1"> }</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-5">// Runtime errors - throw and let the handler convert to system errors</span><br/><span class="hl-3">throw</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&#39;Database connection failed&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">// Contract violations - these bubble up as ConfigViolation or ContractViolation</span><br/><span class="hl-5">// These indicate serious system issues that need immediate attention</span>
</code><button type="button">Copy</button></pre>

<a id="md:testing-your-handler" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Testing Your Handler<a href="#md:testing-your-handler" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Testing handlers is straightforward thanks to the factory pattern:</p>
<pre><code class="typescript"><span class="hl-5">// test/user-registration-handler.test.ts</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoEventFactory</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">userRegistrationHandlerFactory</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../handlers/user-registration-handler&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">UserDatabase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../services/database&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">describe</span><span class="hl-1">(</span><span class="hl-2">&#39;User Registration Handler&#39;</span><span class="hl-1">, () </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">let</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">: </span><span class="hl-9">UserDatabase</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-6">let</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">: </span><span class="hl-9">ReturnType</span><span class="hl-1">&lt;</span><span class="hl-6">typeof</span><span class="hl-1"> </span><span class="hl-4">userRegistrationHandlerFactory</span><span class="hl-1">&gt;;</span><br/><span class="hl-1">    </span><span class="hl-6">let</span><span class="hl-1"> </span><span class="hl-4">eventFactory</span><span class="hl-1">: </span><span class="hl-9">ReturnType</span><span class="hl-1">&lt;</span><span class="hl-6">typeof</span><span class="hl-1"> </span><span class="hl-4">createArvoEventFactory</span><span class="hl-1">&gt;;</span><br/><br/><span class="hl-1">    </span><span class="hl-0">beforeEach</span><span class="hl-1">(() </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">database</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">UserDatabase</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-4">handler</span><span class="hl-1"> = </span><span class="hl-0">userRegistrationHandlerFactory</span><span class="hl-1">({ </span><span class="hl-4">database</span><span class="hl-1"> });</span><br/><span class="hl-1">        </span><span class="hl-4">eventFactory</span><span class="hl-1"> = </span><span class="hl-0">createArvoEventFactory</span><span class="hl-1">(</span><span class="hl-4">userRegistrationContract</span><span class="hl-1">.</span><span class="hl-0">version</span><span class="hl-1">(</span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-1">));</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-0">it</span><span class="hl-1">(</span><span class="hl-2">&#39;should successfully register a new user&#39;</span><span class="hl-1">, </span><span class="hl-6">async</span><span class="hl-1"> () </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">event</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">            </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;test&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;test@example.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;testuser&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;password123&#39;</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        });</span><br/><br/><span class="hl-1">        </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">).</span><span class="hl-0">toHaveLength</span><span class="hl-1">(</span><span class="hl-8">1</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">type</span><span class="hl-1">).</span><span class="hl-0">toBe</span><span class="hl-1">(</span><span class="hl-2">&#39;evt.user.registered&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">user_id</span><span class="hl-1">).</span><span class="hl-0">toBeDefined</span><span class="hl-1">();</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-0">it</span><span class="hl-1">(</span><span class="hl-2">&#39;should reject duplicate emails&#39;</span><span class="hl-1">, </span><span class="hl-6">async</span><span class="hl-1"> () </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Create first user</span><br/><span class="hl-1">        </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">.</span><span class="hl-0">createUser</span><span class="hl-1">(</span><span class="hl-2">&#39;test@example.com&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;user1&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;pass&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">event</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">            </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;test&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;test@example.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;user2&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;password123&#39;</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        });</span><br/><br/><span class="hl-1">        </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">type</span><span class="hl-1">).</span><span class="hl-0">toBe</span><span class="hl-1">(</span><span class="hl-2">&#39;evt.user.registration.failed&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">result</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">error_code</span><span class="hl-1">).</span><span class="hl-0">toBe</span><span class="hl-1">(</span><span class="hl-2">&#39;EMAIL_EXISTS&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="md:whats-next" class="tsd-anchor"></a><h2 class="tsd-anchor-link">What's Next?<a href="#md:whats-next" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Now that you understand the basics of ArvoEventHandler, you can explore:</p>
<ol>
<li><strong><a href="#md:managing-service-evolution-through-contracts">Contract Evolution</a></strong> - Learn how to evolve your handlers while maintaining backward compatibility</li>
<li><strong><a href="#md:multi-domain-event-broadcasting">Multi-Domain Broadcasting</a></strong> - Route events to different processing contexts</li>
<li><strong><a href="#md:error-handling">Error Handling Strategies</a></strong> - Master the different types of errors and how to handle them</li>
<li><strong><a href="#md:testing-event-handlers-in-arvo">Testing Patterns</a></strong> - Build comprehensive test suites for your handlers</li>
<li><strong><a href="./ArvoOrchestrator.md">Orchestration</a></strong> - Coordinate complex workflows across multiple services</li>
</ol>
<p>The patterns you've learned here form the foundation for building reliable, evolvable event-driven systems with Arvo.</p>
<a id="md:principles-of-reliable-event-driven-systems" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Principles of Reliable Event-Driven Systems<a href="#md:principles-of-reliable-event-driven-systems" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Arvo is engineered as an evolutionary event-driven architecture that strives to create systems that are reliable, adaptable, and transparent. In event-driven systems, the majority of complexity stems from inter-service communication. Arvo manages these complexities by enforcing several fundamental principles:</p>
<ol>
<li>All interservice communication is async and event driven</li>
<li>All events in the system are¬†<code>ArvoEvent</code>, which extends¬†<code>CloudEvent</code>¬†with additional routing and opentelemetry extensions</li>
<li>All interservice communications are bound and validated by a contract system, with services coupling to contracts rather than directly to other services and channels</li>
</ol>
<p>Service contracts are not novel; various specifications exist for defining them, such as OpenAPI, AsyncAPI, and Protocol Buffers. However, in practice, these specifications often devolve into producer-driven documentation or become outdated unless development teams maintain extremely rigorous standards. This degradation occurs because software systems are living entities that evolve over time, managed by diverse teams with varying priorities and perspectives.</p>
<p>In an ideal scenario, these contracts serve as crucial tools for creating evolvable and reliable systems. When the entire system recognizes service contracts and consistently upholds them, inter-service communication becomes dependable. Service developers gain the freedom to modify their implementations as needed, provided they maintain their contractual obligations. Furthermore, when properly implemented and thoughtfully designed, these contracts create robust pathways for system evolution while preserving backward compatibility. However, practical limitations in both specifications and ecosystems often prevent achieving these ideal outcomes.</p>
<a id="md:contract-first-development-in-typescript" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Contract-First Development in TypeScript<a href="#md:contract-first-development-in-typescript" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Arvo draws inspiration from established service contract practices and foundational software engineering theories, including Meyer's Design by Contract and Fowler's Tolerant Reader pattern, to create a more robust and naturally enforceable contract system. At its core, Arvo champions a contract-first development approach, implementing contracts as TypeScript objects that provide comprehensive type safety. The framework's <code>ArvoEventHandler</code> must be paired with an <code>ArvoContract</code> to create service implementations, ensuring consistent contract enforcement throughout the development lifecycle.</p>
<blockquote>
<p>While this approach makes Arvo specifically TypeScript-oriented, the underlying principles can be implemented in any programming language. Arvo considers this TypeScript specialisation an acceptable trade-off for building evolutionary architectures, particularly given TypeScript's versatility in web development at all levels. The strong typing system and modern development features of TypeScript enable Arvo to provide a more cohesive and maintainable contract-based development experience.</p>
</blockquote>
<a id="md:implementing-your-first-arvo-service" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Implementing Your First Arvo Service<a href="#md:implementing-your-first-arvo-service" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Building services with ArvoEventHandler follows a thoughtful, contract-first approach that ensures type safety and maintainable code. The process begins with contract definition and moves through to implementation, with TypeScript's type system helping ensure correctness at every step.</p>
<p>Let's explore a practical example of creating a user service. We'll start by importing the necessary components and defining our contract. The contract will specify what our service accepts and what it can emit:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoContract</span><span class="hl-1">, </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-4">ArvoEvent</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoEventHandler</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-event-handler&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;zod&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">// Our contract defines the service interface</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userCreateContract</span><span class="hl-1"> = </span><span class="hl-0">createArvoContract</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">uri:</span><span class="hl-1"> </span><span class="hl-2">&quot;#/sample/user/create&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&quot;com.create.user&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">versions:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">&quot;1.0.0&quot;</span><span class="hl-4">:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">accepts:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">                </span><span class="hl-4">age:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">number</span><span class="hl-1">(),</span><br/><span class="hl-1">            }),</span><br/><span class="hl-1">            </span><span class="hl-4">emits:</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-2">&quot;evt.create.user.success&quot;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                    </span><span class="hl-4">created:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">boolean</span><span class="hl-1">()</span><br/><span class="hl-1">                })</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>With our contract in place, we can define the core business logic of our service. By separating this logic from the event handling, we maintain cleaner code organization and make our service easier to test:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">createUser</span><span class="hl-1"> = (</span><span class="hl-4">name</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">, </span><span class="hl-4">age</span><span class="hl-1">: </span><span class="hl-9">number</span><span class="hl-1">): </span><span class="hl-9">boolean</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Implementation of user creation logic</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1">; </span><span class="hl-5">// Simplified for example</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p>While this example demonstrates a clean separation of concerns by extracting the business logic into a standalone function, real-world service development often follows a different path. In practice, it's often more effective to start by implementing the functionality directly within the handler function. This approach allows you to fully understand the service's requirements and usage patterns in context. As the service matures and patterns emerge through actual use, you can then thoughtfully extract and abstract common functionalities. This evolution-based approach helps prevent premature abstractions and ensures that when you do create separate functions, they genuinely serve the service's needs and reflect real usage patterns rather than speculative design.</p>
</blockquote>
<p>Now we can create our event handler, binding it to our contract and implementing the business logic for each version. The handler maps incoming events to their appropriate version-specific implementations:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">handlerFactory</span><span class="hl-1">: </span><span class="hl-9">EventHandlerFactory</span><span class="hl-1"> = () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">contract:</span><span class="hl-1"> </span><span class="hl-4">userCreateContract</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">executionunits:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1">, </span><span class="hl-5">// Business-defined execution cost</span><br/><span class="hl-1">    </span><span class="hl-4">handler:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Version-specific implementation</span><br/><span class="hl-1">        </span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({</span><span class="hl-4">event</span><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userCreated</span><span class="hl-1"> = </span><span class="hl-0">createUser</span><span class="hl-1">(</span><br/><span class="hl-1">                </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">name</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">age</span><br/><span class="hl-1">            );</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.create.user.success&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">data:</span><span class="hl-1"> { </span><span class="hl-4">created:</span><span class="hl-1"> </span><span class="hl-4">userCreated</span><span class="hl-1"> },</span><br/><span class="hl-1">            };</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">handler</span><span class="hl-1"> = </span><span class="hl-0">handlerFactory</span><span class="hl-1">()</span>
</code><button type="button">Copy</button></pre>

<p>Notice how the handler's version key ('1.0.0') corresponds to the contract version. When an event arrives with a matching <code>dataschema</code> version, the handler routes it to the appropriate implementation. This versioning system ensures that each implementation adheres strictly to its contract version, allowing the service to evolve while maintaining backward compatibility. Developers can modify the implementation details freely as long as they maintain the contract's requirements.</p>
<a id="md:the-factory-pattern---eventhandlerfactory" class="tsd-anchor"></a><h3 class="tsd-anchor-link">The factory pattern - <code>EventHandlerFactory</code><a href="#md:the-factory-pattern---eventhandlerfactory" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>EventHandlerFactory</code> is a core type in the <code>arvo-event-handler</code> package that provides the foundation for creating event handlers. Rather than directly using <code>createArvoEventHandler</code>, services should be built using this factory type. It enforces a consistent pattern for dependency injection by defining an explicit contract for what a handler requires to function. When a developer implements the <code>EventHandlerFactory</code> type, they're creating a blueprint that specifies both the handler's dependencies and its implementation. This type-driven approach ensures that all necessary dependencies are properly declared and managed through TypeScript's type system, making the relationships between handlers and their required resources clear and maintainable.</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-4">EventHandlerFactory</span><span class="hl-1">, </span><span class="hl-4">createArvoEventHandler</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-event-handler&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-9">HandlerDependencies</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">database</span><span class="hl-1">: </span><span class="hl-9">DatabaseClient</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-4">config</span><span class="hl-1">: {</span><br/><span class="hl-1">        </span><span class="hl-4">maxRetries</span><span class="hl-1">: </span><span class="hl-9">number</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-4">timeout</span><span class="hl-1">: </span><span class="hl-9">number</span><span class="hl-1">;</span><br/><span class="hl-1">    };</span><br/><span class="hl-1">    </span><span class="hl-4">logger</span><span class="hl-1">: </span><span class="hl-9">Logger</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">userCreateHandlerFactory</span><span class="hl-1">: </span><span class="hl-9">EventHandlerFactory</span><span class="hl-1">&lt;</span><span class="hl-9">HandlerDependencies</span><span class="hl-1">&gt; = ({</span><br/><span class="hl-1">    </span><span class="hl-4">database</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">config</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">logger</span><br/><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">contract:</span><span class="hl-1"> </span><span class="hl-4">userCreateContract</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">executionunits:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">handler:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({</span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">span</span><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-5">// Dependencies are available in scope</span><br/><span class="hl-1">            </span><span class="hl-4">logger</span><span class="hl-1">.</span><span class="hl-0">info</span><span class="hl-1">(</span><span class="hl-2">&#39;Processing user creation&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">user</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">.</span><span class="hl-0">createUser</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.create.user.success&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">data:</span><span class="hl-1"> { </span><span class="hl-4">created:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1"> }</span><br/><span class="hl-1">            };</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>While the factory pattern may initially appear to introduce additional boilerplate compared to direct handler creation, this structure serves a crucial architectural purpose. Even for handlers without dependencies, using¬†<code>EventHandlerFactory</code>establishes a consistent pattern across all services and enables future evolution. Services that start simple often grow to require dependencies as business needs evolve - using the factory pattern from the start makes this transition seamless without requiring structural changes to the codebase. The factory pattern also maintains uniformity in how services are constructed and tested across a system, making codebases more maintainable and easier to understand for development teams.</p>
<a id="md:anatomy-of-a-handler-function" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Anatomy of a handler function<a href="#md:anatomy-of-a-handler-function" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When implementing a <code>ArvoEventHandler</code>, each version of your service gets its own dedicated function for processing events. The handler function is always an asynchronous function that receives a rich context object containing three key pieces of information:</p>
<ul>
<li>The <code>event</code> is a pre-validated input that has been rigorously checked against the contract's schema before reaching the handler. This validation ensures that by the time the handler receives the event, its structure is guaranteed to be correct. TypeScript integration provides additional safety: your IDE will offer intelligent autocomplete for data fields, and the TypeScript compiler will immediately highlight any type mismatches or structural errors during development.</li>
<li>The <code>source</code> parameter represents the service's identity, typically matching the contract's type.</li>
<li>The <code>span</code> is an OpenTelemetry tracing object that enables sophisticated observability. It allows developers to add rich metadata and logging information throughout the service's execution trace, providing deep insights into the system's behaviour and performance.</li>
</ul>
<p>Here's how this data from the context come to life in a real event handler implementation:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">logToSpan</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">handler</span><span class="hl-1"> = </span><span class="hl-0">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">contract:</span><span class="hl-1"> </span><span class="hl-4">userCreateContract</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">executionunits:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1">, </span><span class="hl-5">// Business-defined execution cost</span><br/><span class="hl-1">    </span><span class="hl-4">handler:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-5">// Version-specific implementation</span><br/><span class="hl-1">        </span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({</span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">source</span><span class="hl-1">, </span><span class="hl-4">span</span><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-5">// The types are:</span><br/><span class="hl-1">            </span><span class="hl-5">// - event: ArvoEvent</span><br/><span class="hl-1">            </span><span class="hl-5">// - source: string</span><br/><span class="hl-1">            </span><span class="hl-5">// - span: Span &lt;from opentelemetry&gt;</span><br/><span class="hl-1">            </span><span class="hl-5">//</span><br/><span class="hl-1">            </span><span class="hl-5">// Adding some more attributes for logging</span><br/><span class="hl-1">            </span><span class="hl-4">span</span><span class="hl-1">.</span><span class="hl-0">setAttribute</span><span class="hl-1">(</span><span class="hl-2">&#39;sample-service-name&#39;</span><span class="hl-1">, </span><span class="hl-4">source</span><span class="hl-1">)</span><br/><br/><span class="hl-1">            </span><span class="hl-5">// The function automatically figures of the appropriate span</span><br/><span class="hl-1">            </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">                </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">&quot;Service started&quot;</span><br/><span class="hl-1">            })</span><br/><br/><span class="hl-1">            </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userCreated</span><span class="hl-1"> = </span><span class="hl-0">createUser</span><span class="hl-1">(</span><br/><span class="hl-1">                </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">name</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">age</span><br/><span class="hl-1">            );</span><br/><br/><span class="hl-1">            </span><span class="hl-5">// The target span to log event to can explicitly be defined</span><br/><span class="hl-1">            </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">                </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">&quot;Service started&quot;</span><br/><span class="hl-1">            }, </span><span class="hl-4">span</span><span class="hl-1">)</span><br/><span class="hl-1">            </span><br/><span class="hl-1">            </span><span class="hl-4">span</span><span class="hl-1">.</span><span class="hl-0">setAttribute</span><span class="hl-1">(</span><span class="hl-2">&#39;sample-execution-cost&#39;</span><span class="hl-1">, </span><span class="hl-8">10</span><span class="hl-1">)</span><br/><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.create.user.success&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">data:</span><span class="hl-1"> { </span><span class="hl-4">created:</span><span class="hl-1"> </span><span class="hl-4">userCreated</span><span class="hl-1"> },</span><br/><span class="hl-1">            };</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>This example demonstrates an Arvo event handler for user creation that leverages OpenTelemetry tracing. It adds custom attributes to the span (like service name and execution cost), logs informational messages about the service's execution, and performs the core user creation logic. The handler uses both implicit and explicit logging with¬†<code>logToSpan</code>, showcasing how developers can easily inject observability into their event processing without disrupting the main business logic.</p>
<a id="md:logging-mechanism" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Logging Mechanism<a href="#md:logging-mechanism" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Arvo introduces <code>logToSpan</code>, a utility designed to integrate logging directly into OpenTelemetry tracing spans. This function enables developers to add structured <strong>log events</strong> throughout event processing while maintaining clean, uncluttered business logic.</p>
<p>With <code>logToSpan</code>, logging becomes a seamless part of observability. Developers can:</p>
<ul>
<li>Log messages with various severity levels</li>
<li>Attach contextual information</li>
<li>Precisely correlate logs with specific traces and spans</li>
</ul>
<p>The utility abstracts away the complexities of span management. Whether you want to use the current active span or explicitly specify a target span, <code>logToSpan</code> handles the details of log attachment automatically. This approach provides a consistent, developer-friendly method for capturing runtime information across distributed event-driven systems.</p>
<p>By integrating logging directly into the tracing mechanism, Arvo ensures that every log event is not just a message, but a rich, traceable piece of system log. Developers can focus on their core logic, knowing that observability is built-in and effortless.</p>
<a id="md:managing-service-evolution-through-contracts" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Managing Service Evolution Through Contracts<a href="#md:managing-service-evolution-through-contracts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>ArvoEventHandler</code> takes a unique approach to contract versioning, treating each version as a completely independent entity, both functionally and semantically. This design isn't just a technical choice - it reflects Arvo's fundamental philosophy about how services should evolve in distributed systems.</p>
<p>When an <code>ArvoEventHandler</code> binds to a contract, it enforces a strict requirement: every version defined in the <code>ArvoContract</code> must have a corresponding implementation in the handler. While this might initially seem to promote code duplication, it serves a deeper purpose. This approach ensures complete and reliable backward compatibility while giving developers the freedom to implement version-specific business logic and manage their deprecation strategies according to business needs.</p>
<p>Let's explore this through a practical example. Imagine a scenario where a new consumer needs to provide a date of birth instead of age when creating users. This requirement may leads us to create a new contract version:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoContract</span><span class="hl-1">, </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-4">ArvoEvent</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoEventHandler</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-event-handler&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1"> </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;zod&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userCreateContract</span><span class="hl-1"> = </span><span class="hl-0">createArvoContract</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">uri:</span><span class="hl-1"> </span><span class="hl-2">&quot;#/sample/user/create&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&quot;com.create.user&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">versions:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">&quot;1.0.0&quot;</span><span class="hl-4">:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">accepts:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">                </span><span class="hl-4">age:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">number</span><span class="hl-1">(),</span><br/><span class="hl-1">            }),</span><br/><span class="hl-1">            </span><span class="hl-4">emits:</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-2">&quot;evt.create.user.success&quot;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                    </span><span class="hl-4">created:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">boolean</span><span class="hl-1">()</span><br/><span class="hl-1">                })</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">        </span><span class="hl-2">&quot;2.0.0&quot;</span><span class="hl-4">:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">accepts:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">                </span><span class="hl-4">dob:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(), </span><span class="hl-5">// Changed from age to date of birth</span><br/><span class="hl-1">            }),</span><br/><span class="hl-1">            </span><span class="hl-4">emits:</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-2">&quot;evt.create.user.success&quot;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">                    </span><span class="hl-4">created:</span><span class="hl-1"> </span><span class="hl-4">z</span><span class="hl-1">.</span><span class="hl-0">boolean</span><span class="hl-1">()</span><br/><span class="hl-1">                })</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p><strong>Interesting Point</strong>: According to the ArvoContract documentation, introducing a new field format (changing from age to dob) could be handled through a union type in the same version since it increases permissiveness while preserving existing functionality. While this would result in less code, creating a new version offers cleaner separation of concerns and easier tracking of consumer requirements. Consider your specific needs - union types for simpler changes and gradual adoption, new versions for clearer boundaries and independent evolution paths. Both approaches are valid within Arvo's contract evolution principles; choose based on your maintenance strategy and consumer needs.</p>
</blockquote>
<p>Rather than duplicating all our business logic, we can maintain our core functionality while adding version-specific transformations. Notice how the <code>createUser</code> function remains unchanged while we add a new helper function to handle the date of birth conversion:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">createUser</span><span class="hl-1"> = (</span><span class="hl-4">name</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">, </span><span class="hl-4">age</span><span class="hl-1">: </span><span class="hl-9">number</span><span class="hl-1">): </span><span class="hl-9">boolean</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">// Core business logic remains stable</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1">;</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">calculateAge</span><span class="hl-1"> = (</span><span class="hl-4">dob</span><span class="hl-1">: </span><span class="hl-9">string</span><span class="hl-1">): </span><span class="hl-9">number</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">birthDate</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">(</span><span class="hl-4">dob</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">today</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-3">return</span><span class="hl-1"> </span><span class="hl-4">today</span><span class="hl-1">.</span><span class="hl-0">getFullYear</span><span class="hl-1">() - </span><span class="hl-4">birthDate</span><span class="hl-1">.</span><span class="hl-0">getFullYear</span><span class="hl-1">();</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">handlerFactory</span><span class="hl-1">: </span><span class="hl-9">EventHandlerFactory</span><span class="hl-1"> = () </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">contract:</span><span class="hl-1"> </span><span class="hl-4">userCreateContract</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">executionunits:</span><span class="hl-1"> </span><span class="hl-8">1</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">handler:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({</span><span class="hl-4">event</span><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userCreated</span><span class="hl-1"> = </span><span class="hl-0">createUser</span><span class="hl-1">(</span><br/><span class="hl-1">                </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">name</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">age</span><br/><span class="hl-1">            );</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.create.user.success&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">data:</span><span class="hl-1"> { </span><span class="hl-4">created:</span><span class="hl-1"> </span><span class="hl-4">userCreated</span><span class="hl-1"> }</span><br/><span class="hl-1">            };</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">        </span><span class="hl-2">&#39;2.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({</span><span class="hl-4">event</span><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">age</span><span class="hl-1"> = </span><span class="hl-0">calculateAge</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">dob</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userCreated</span><span class="hl-1"> = </span><span class="hl-0">createUser</span><span class="hl-1">(</span><br/><span class="hl-1">                </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">name</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">age</span><br/><span class="hl-1">            );</span><br/><span class="hl-1">            </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.create.user.success&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                </span><span class="hl-4">data:</span><span class="hl-1"> { </span><span class="hl-4">created:</span><span class="hl-1"> </span><span class="hl-4">userCreated</span><span class="hl-1"> },</span><br/><span class="hl-1">                </span><span class="hl-4">executionunits:</span><span class="hl-1"> </span><span class="hl-8">2</span><span class="hl-1">, </span><span class="hl-5">// A override cost specific to this version </span><br/><span class="hl-1">            };</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">handler</span><span class="hl-1"> = </span><span class="hl-0">handlerFactory</span><span class="hl-1">()</span>
</code><button type="button">Copy</button></pre>

<p>This pattern demonstrates how Arvo promotes evolution while maintaining reliability. The isolation between handler functions for different versions is intentional - it allows each version to evolve independently while preserving the integrity of the service contract. This approach enables teams to add new consumers with different requirements while maintaining existing functionality, and it provides the flexibility to implement sunset strategies based on business needs rather than technical limitations.</p>
<p>The slight increase in code volume is a conscious trade-off, chosen to prioritise system reliability and evolution over code conciseness. This approach may proven particularly valuable in large-scale systems where the cost of breaking changes far outweighs the cost of maintaining version-specific handlers.</p>
<a id="md:event-processing-and-execution-flow" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event Processing and Execution Flow<a href="#md:event-processing-and-execution-flow" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>To demonstrate how this all works together, let's look at a simple execution flow that shows how events flow through the system - from creation through processing to response:</p>
<pre><code class="typescript"><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">function</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">inputEvent</span><span class="hl-1">: </span><span class="hl-9">ArvoEvent</span><span class="hl-1"> = </span><span class="hl-0">createArvoEventFactory</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-4">userCreateContract</span><span class="hl-1">.</span><span class="hl-0">version</span><span class="hl-1">(</span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">    ).</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">subject:</span><span class="hl-1"> </span><span class="hl-2">&quot;some-subject&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&quot;com.test.test&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-2">&quot;John Doe&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">age:</span><span class="hl-1"> </span><span class="hl-8">65</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1">: </span><span class="hl-9">ArvoEvent</span><span class="hl-1">[] = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><br/><span class="hl-1">         </span><span class="hl-4">inputEvent</span><span class="hl-1">        </span><br/><span class="hl-1">    )</span><br/><span class="hl-1">}</span><br/><span class="hl-0">main</span><span class="hl-1">().</span><span class="hl-0">catch</span><span class="hl-1">(</span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-4">error</span><span class="hl-1">)</span>
</code><button type="button">Copy</button></pre>

<a id="md:what-happens-here" class="tsd-anchor"></a><h3 class="tsd-anchor-link">What Happens Here?<a href="#md:what-happens-here" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Let's break down this execution flow to understand how Arvo processes events through the system. The execution begins with event creation through the¬†<code>createArvoEventFactory</code>. This factory, initialized with version '1.0.0' of our contract, ensures all event creation strictly follows the version's schema specifications.</p>
<p>The¬†<code>accepts</code>¬†method then generates an event matching our contract's input requirements, carefully structuring the data with¬†<code>name</code>¬†and¬†<code>age</code>¬†fields to align with our contract's accept schema. This ensures type safety from the very beginning of our event's lifecycle.</p>
<p>The core processing occurs when we call¬†<code>handler.execute</code>. The handler first validates the incoming event against the contract specifications. Upon successful validation, it routes the event to the correct version-specific implementation by examining the event's¬†<code>dataschema</code>. This implementation then processes the event according to its business logic and produces response events. Before these response events leave the handler, they undergo validation against the contract's emit schema, ensuring they meet all specified requirements.</p>
<p>At the end of this flow, we receive our array of response events stored in¬†<code>result</code>. Each event in this array has been fully validated and is guaranteed to conform to our contract's specifications, maintaining the integrity of our service's communication interface.</p>
<a id="md:understanding-the-handler-interface" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Understanding the Handler Interface<a href="#md:understanding-the-handler-interface" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All event handlers in Arvo follow a consistent signature:¬†<code>ArvoEvent =&gt; Promise&lt;{ events:ArvoEvent[] }&gt;</code>. This unified interface offers several key advantages:</p>
<p>This simple yet powerful pattern means every handler takes an ArvoEvent as input and returns a Promise that resolves to an array of ArvoEvents. The promise wrapper enables asynchronous processing, while returning an array of events allows handlers to trigger multiple consequent actions when needed. This uniformity creates a predictable flow of events through the system, making it easier to reason about service behavior and compose complex workflows.</p>
<p>Whether you're building a simple service like our user creation example or orchestrating complex business processes, this consistent interface ensures that all services speak the same language and can be composed reliably. The handler's contract validation ensures that both incoming and outgoing events adhere to their specified schemas, maintaining type safety throughout the event chain.</p>
<a id="md:error-handling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Error Handling<a href="#md:error-handling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Error handling forms a critical foundation for building reliable event-driven systems. <code>ArvoEventHandler</code> implements a sophisticated error handling strategy that recognises different categories of issues and provides appropriate mechanisms for dealing with each.</p>
<p>At its core, Arvo distinguishes between two fundamental types of errors: system errors that occur during normal operation and can potentially be recovered from, and violations that indicate serious structural or configuration issues requiring immediate attention.</p>
<blockquote>
<p>When implementing handler functions, you should throw errors naturally and let them propagate. The¬†<code>ArvoEventHandler</code>will catch these errors and automatically transform them into appropriate system error events. The following sections explain what happens when you call¬†<code>handler.execute(event)</code>¬†and how different types of errors are processed.</p>
</blockquote>
<a id="md:system-error-events" class="tsd-anchor"></a><h3 class="tsd-anchor-link">System Error Events<a href="#md:system-error-events" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>System errors represent operational issues that occur during the normal execution of a service. These might include temporary network failures, resource constraints, or other transient conditions that could resolve with time or retry attempts. When an uncaught error occurs within a handler function, Arvo automatically converts it into a standardised system error event.</p>
<p>The system error events follow a consistent format defined by the <code>ArvoContract</code>, with the type <code>sys.&lt;contract-type&gt;.error</code>. This standardisation ensures that error handling remains consistent across the system and enables automated processing of error conditions. For example, in our user creation service, a system error event might look like this:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-4">ArvoErrorType</span><span class="hl-1">, </span><span class="hl-4">createArvoError</span><span class="hl-1">, </span><span class="hl-4">createArvoEvent</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">sampleErrorEvent</span><span class="hl-1"> = </span><span class="hl-0">createArvoEvent</span><span class="hl-1">({</span><br/><span class="hl-1">    ...</span><span class="hl-4">rest</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;sys.com.user.create.error&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">data:</span><span class="hl-1"> </span><span class="hl-0">createArvoError</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;Some random error&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    ), </span><span class="hl-5">// satisfies ArvoErrorType</span><br/><span class="hl-1">})</span><br/><br/><span class="hl-5">/**</span><br/><span class="hl-5"> * The event will be...</span><br/><span class="hl-5"> * ArvoEvent&lt;ArvoErrorType, {}, `sys.com.user.create.error`&gt;</span><br/><span class="hl-5"> * = {</span><br/><span class="hl-5"> *   type: &quot;sys.com.user.create.error&quot;,</span><br/><span class="hl-5"> *   data: {</span><br/><span class="hl-5"> *      errorName: string,</span><br/><span class="hl-5"> *      errorMessage: string,</span><br/><span class="hl-5"> *      errorStack: string | null</span><br/><span class="hl-5"> *   },</span><br/><span class="hl-5"> *   ...rest</span><br/><span class="hl-5"> * }</span><br/><span class="hl-5"> */</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p>While the example above shows the error event structure, developers should never create these error events directly. The <code>ArvoEventHandler</code> automatically generates and emits system errors when uncaught exceptions occur during execution. This ensures consistent error handling across the system.</p>
</blockquote>
<a id="md:violations" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Violations<a href="#md:violations" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>While system errors represent operational issues, violations indicate fundamental problems with how the system is configured or being used. These are serious issues that could compromise system integrity if allowed to continue. Unlike system errors that are returned as events, violations are thrown as exceptions that must be handled explicitly.</p>
<p>Arvo defines three distinct types of violations, each serving a specific purpose in maintaining system integrity:</p>
<a id="md:configviolation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">ConfigViolation<a href="#md:configviolation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The <code>ConfigViolation</code> indicates fundamental mismatches between events and their handlers. This might occur when events are routed to the wrong service (like sending a payment event to a user service) or when events specify nonexistent contract versions. These violations help catch system configuration errors before they can cause cascading failures.</p>
<a id="md:contractviolation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">ContractViolation<a href="#md:contractviolation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The <code>ContractViolation</code> occurs when events fail to meet their contractual obligations. This happens when incoming or outgoing events fail schema validation, when event URIs don't match their handler contracts, or when data types don't align with schema requirements. These violations typically indicate implementation bugs or data corruption issues that require developer attention.</p>
<a id="md:executionviolation" class="tsd-anchor"></a><h4 class="tsd-anchor-link">ExecutionViolation<a href="#md:executionviolation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><blockquote>
<p><strong>WARNING!</strong> Do not use it for normal business failures (leverage system errors mechanism), validation failures (leverage <code>ContractViolation</code>), routing issues (leverage <code>ConfigViolation</code>), or temporary failures that could succeed on retry.</p>
</blockquote>
<p><code>ExecutionViolation</code> is a developer-controlled mechanism for handling extraordinary cases. They serves as an infrastructure-level signal rather than an error condition. Its primary purpose is to act as a circuit breaker mechanism, indicating that message processing should cease and the event should be moved to a dead letter queue for investigation. This violation type is particularly useful in preventing harmful processing loops or handling unrecoverable semantic errors.</p>
<p>Handling violations in practice:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-3">type</span><span class="hl-1"> { </span><span class="hl-4">ConfigViolation</span><span class="hl-1">, </span><span class="hl-4">ContractViolation</span><span class="hl-1">, </span><span class="hl-4">ExecutionViolation</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-event-handler&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">try</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">result</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">inputEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-5">// Process successful result</span><br/><span class="hl-1">} </span><span class="hl-3">catch</span><span class="hl-1"> (</span><span class="hl-4">error</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> ((</span><span class="hl-4">e</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-9">ConfigViolation</span><span class="hl-1">)?.</span><span class="hl-4">name</span><span class="hl-1"> === </span><span class="hl-2">&#39;ViolationError&lt;Config&gt;&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// Do something...</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> ((</span><span class="hl-4">e</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-9">ContractViolation</span><span class="hl-1">)?.</span><span class="hl-4">name</span><span class="hl-1"> === </span><span class="hl-2">&#39;ViolationError&lt;Contract&gt;&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// Do something...</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-3">if</span><span class="hl-1"> ((</span><span class="hl-4">e</span><span class="hl-1"> </span><span class="hl-3">as</span><span class="hl-1"> </span><span class="hl-9">ExecutionViolation</span><span class="hl-1">)?.</span><span class="hl-4">name</span><span class="hl-1"> === </span><span class="hl-2">&#39;ViolationError&lt;Execution&gt;&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-5">// Do something...</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>With this structured approach to error handling, Arvo attempts to enables developers to build robust, self-healing systems while ensuring that serious issues receive immediate attention.</p>
<a id="md:a-note-on-contract-validation-performance" class="tsd-anchor"></a><h2 class="tsd-anchor-link">A Note on Contract Validation Performance<a href="#md:a-note-on-contract-validation-performance" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Contract validation is an integral part of the event handler execution process in Arvo, occurring for both incoming and outgoing events against the <code>ArvoContract</code>. While this might initially raise performance concerns, several architectural decisions help minimise any potential overhead.</p>
<p>At the core of Arvo's validation system lies the Zod package, a widely adopted TypeScript schema validation library. Zod not only handles validation but also manages default value population in a single pass, eliminating the need for separate processing steps. This integration provides a robust foundation for type safety while maintaining efficient execution.</p>
<p>The centralised validation approach through <code>ArvoContract</code> eliminates the need for individual validation logic in each handler implementation. This not only reduces code redundancy but also ensures consistency across services. In the context of distributed systems, the validation overhead is minimal compared to typical network latency and business logic execution times. Since validation is a necessary component of most applications, integrating it at the contract level provides comprehensive type safety without significant performance impact.</p>
<p>While Zod can face performance challenges when validating deeply nested structures, large datasets, or complex types like unions and arrays, these limitations are offset by its comprehensive feature set and mature API. To address potential IDE performance impacts in large systems with numerous contracts, Arvo recommends implementing contracts in separate packages distributed through monorepo structures or package registries. This approach leverages TypeScript's compilation process, generating declaration files that optimise IDE performance through transpiled type declarations.</p>
<p>It's worth noting that in typical event-driven architectures, these performance considerations rarely become bottlenecks, as network latency and database operations usually dominate the performance profile. For cases requiring exceptional performance, developers can implement custom handlers. Arvo's design philosophy prioritises reasonable performance for typical use cases rather than extreme computational efficiency.</p>
<blockquote>
<p>In Arvo's event-driven architecture, events typically serve as commands and responses between services. Since these events represent service interactions rather than data storage or transfer mechanisms, large event payloads may indicate a violation of single responsibility principles - where an event is trying to do too much or carry too much information. This could make the system harder to maintain and evolve over time. For scenarios involving large datasets, consider whether the data transfer could be better handled through other mechanisms while keeping the event focused on the service interaction itself.</p>
</blockquote>
<a id="md:multi-domain-event-broadcasting" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Multi-Domain Event Broadcasting<a href="#md:multi-domain-event-broadcasting" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><blockquote>
<p><strong>Caution:</strong> Don't use domained contracts unless it is fully intentional. Using domained contracts causes implicit domain assignment which can be hard to track and confusing. For 99% of the cases you dont need domained contracts.</p>
</blockquote>
<p>The ArvoEventHandler supports sophisticated multi-domain event distribution through array-based domain specification. This powerful feature allows events to be broadcast across multiple processing contexts simultaneously.</p>
<a id="md:understanding-domains" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Understanding Domains<a href="#md:understanding-domains" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>In Arvo, domains represent different processing contexts or routing namespaces for events. They enable sophisticated event distribution patterns where a single handler response can create multiple events for different processing pipelines.</p>
<a id="md:domain-assignment-rules" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Domain Assignment Rules<a href="#md:domain-assignment-rules" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When returning events from a handler, you can specify domains using the <code>domain</code> field:</p>
<ol>
<li><strong>Array Processing</strong>: Each element in the <code>domain</code> array creates a separate ArvoEvent instance</li>
<li><strong><code>undefined</code> in Array Resolution</strong>: <code>undefined</code> elements resolve to: <code>triggeringEvent.domain ?? handler.contract.domain ?? null</code></li>
<li><strong><code>null</code> in Array Resolution</strong>: <code>null</code> elements resolve to events which <code>domain: null</code></li>
<li><strong>Automatic Deduplication</strong>: Duplicate domains are automatically removed to prevent redundant events</li>
<li><strong>Default Behavior</strong>: Omitting the <code>domain</code> field (or setting to <code>undefined</code>) defaults to <code>[null]</code> (single event, no domain)</li>
</ol>
<a id="md:domain-broadcasting-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Domain broadcasting pattern<a href="#md:domain-broadcasting-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Let's look at extending the getting start example to use the domain broadcasting</p>
<a id="md:step-1-update-your-event-handler" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Step 1: Update Your Event Handler<a href="#md:step-1-update-your-event-handler" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>We'll extend the handler to demonstrate domain broadcasting capabilities in <code>handlers/user-registration-handler.ts</code>:</p>
<pre><code class="typescript"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoEventHandler</span><span class="hl-1">, </span><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-4">EventHandlerFactory</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-event-handler&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">logToSpan</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">userRegistrationContract</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../contracts/user-registration&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-3">type</span><span class="hl-1"> { </span><span class="hl-4">UserDatabase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../services/database&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-9">HandlerDependencies</span><span class="hl-1"> = {</span><br/><span class="hl-1">    </span><span class="hl-4">database</span><span class="hl-1">: </span><span class="hl-9">UserDatabase</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Create the handler factory - this is the recommended pattern</span><br/><span class="hl-3">export</span><span class="hl-1"> </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">userRegistrationHandlerFactory</span><span class="hl-1">: </span><span class="hl-9">EventHandlerFactory</span><span class="hl-1">&lt;</span><span class="hl-9">HandlerDependencies</span><span class="hl-1">&gt; = ({</span><br/><span class="hl-1">    </span><span class="hl-4">database</span><br/><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">contract:</span><span class="hl-1"> </span><span class="hl-4">userRegistrationContract</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">executionunits:</span><span class="hl-1"> </span><span class="hl-8">0.001</span><span class="hl-1">, </span><span class="hl-5">// Cost per execution (business-defined)</span><br/><span class="hl-1">  </span><span class="hl-4">handler:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-4">:</span><span class="hl-1"> </span><span class="hl-6">async</span><span class="hl-1"> ({ </span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">source</span><span class="hl-1">, </span><span class="hl-4">span</span><span class="hl-1">, </span><span class="hl-4">domain</span><span class="hl-1"> }) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`Processing user registration for </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">email</span><span class="hl-6">}</span><span class="hl-2">`</span><br/><span class="hl-1">      }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Log domain information for observability</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-4">domain</span><span class="hl-1">.</span><span class="hl-4">event</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">          </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`Event received from domain: </span><span class="hl-6">${</span><span class="hl-4">domain</span><span class="hl-10">.</span><span class="hl-4">event</span><span class="hl-6">}</span><span class="hl-2">`</span><br/><span class="hl-1">        }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Check if email already exists</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">.</span><span class="hl-0">emailExists</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">email</span><span class="hl-1">)) {</span><br/><span class="hl-1">        </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">          </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;WARN&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`Registration failed: Email </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">email</span><span class="hl-6">}</span><span class="hl-2"> already exists`</span><br/><span class="hl-1">        }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.user.registration.failed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">reason:</span><span class="hl-1"> </span><span class="hl-2">&#39;Email address already exists in the system&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">error_code:</span><span class="hl-1"> </span><span class="hl-2">&#39;EMAIL_EXISTS&#39;</span><br/><span class="hl-1">          },</span><br/><span class="hl-1">          </span><span class="hl-5">// Broadcast error to multiple domains for different processing contexts</span><br/><span class="hl-1">          </span><span class="hl-5">// along with the default &#39;null&#39; no-domain event.</span><br/><span class="hl-1">          </span><span class="hl-4">domain:</span><span class="hl-1"> [</span><span class="hl-2">&#39;audit.failures&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;analytics.errors&#39;</span><span class="hl-1">, </span><span class="hl-6">null</span><span class="hl-1">]</span><br/><span class="hl-1">        };</span><br/><span class="hl-1">      }</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Check if username already exists</span><br/><span class="hl-1">      </span><span class="hl-3">if</span><span class="hl-1"> (</span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">.</span><span class="hl-0">usernameExists</span><span class="hl-1">(</span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1">)) {</span><br/><span class="hl-1">        </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">          </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;WARN&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`Registration failed: Username </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">username</span><span class="hl-6">}</span><span class="hl-2"> already taken`</span><br/><span class="hl-1">        }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.user.registration.failed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">reason:</span><span class="hl-1"> </span><span class="hl-2">&#39;Username already taken&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">error_code:</span><span class="hl-1"> </span><span class="hl-2">&#39;USERNAME_TAKEN&#39;</span><br/><span class="hl-1">          },</span><br/><span class="hl-1">          </span><span class="hl-5">// Send failure to audit</span><br/><span class="hl-1">          </span><span class="hl-4">domain:</span><span class="hl-1"> [</span><span class="hl-2">&#39;audit.failures&#39;</span><span class="hl-1">]</span><br/><span class="hl-1">        };</span><br/><span class="hl-1">      }</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Create the user</span><br/><span class="hl-1">      </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userId</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">database</span><span class="hl-1">.</span><span class="hl-0">createUser</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">email</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">password</span><br/><span class="hl-1">      );</span><br/><br/><span class="hl-1">      </span><span class="hl-0">logToSpan</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">level:</span><span class="hl-1"> </span><span class="hl-2">&#39;INFO&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">message:</span><span class="hl-1"> </span><span class="hl-2">`User </span><span class="hl-6">${</span><span class="hl-4">userId</span><span class="hl-6">}</span><span class="hl-2"> created successfully`</span><br/><span class="hl-1">      }, </span><span class="hl-4">span</span><span class="hl-1">);</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Determine if this is a premium user based on email domain</span><br/><span class="hl-1">      </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">isPremiumUser</span><span class="hl-1"> = </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">email</span><span class="hl-1">.</span><span class="hl-0">endsWith</span><span class="hl-1">(</span><span class="hl-2">&#39;@premium.com&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">      </span><span class="hl-5">// Return success event with sophisticated domain broadcasting</span><br/><span class="hl-1">      </span><span class="hl-3">return</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;evt.user.registered&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-4">user_id:</span><span class="hl-1"> </span><span class="hl-4">userId</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">email</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-4">event</span><span class="hl-1">.</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">username</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-4">created_at:</span><span class="hl-1"> </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">Date</span><span class="hl-1">().</span><span class="hl-0">toISOString</span><span class="hl-1">()</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">        </span><span class="hl-5">// Multi-domain broadcasting based on business logic</span><br/><span class="hl-1">        </span><span class="hl-4">domain:</span><span class="hl-1"> </span><span class="hl-4">isPremiumUser</span><span class="hl-1"> ? </span><br/><span class="hl-1">          [</span><br/><span class="hl-1">            </span><span class="hl-2">&#39;analytics.users&#39;</span><span class="hl-1">,      </span><span class="hl-5">// All user analytics</span><br/><span class="hl-1">            </span><span class="hl-2">&#39;crm.premium&#39;</span><span class="hl-1">,         </span><span class="hl-5">// Premium user CRM</span><br/><span class="hl-1">            </span><span class="hl-2">&#39;marketing.vip&#39;</span><span class="hl-1">,       </span><span class="hl-5">// VIP marketing campaigns</span><br/><span class="hl-1">            </span><span class="hl-6">null</span><span class="hl-1">                   </span><span class="hl-5">// Standard processing pipeline</span><br/><span class="hl-1">          ] : </span><br/><span class="hl-1">          [</span><br/><span class="hl-1">            </span><span class="hl-2">&#39;analytics.users&#39;</span><span class="hl-1">,     </span><span class="hl-5">// All user analytics</span><br/><span class="hl-1">            </span><span class="hl-6">undefined</span><span class="hl-1">,             </span><span class="hl-5">// Inherit from event or handler domain</span><br/><span class="hl-1">            </span><span class="hl-6">null</span><span class="hl-1">                   </span><span class="hl-5">// Standard processing pipeline</span><br/><span class="hl-1">          ]</span><br/><span class="hl-1">      };</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="md:step-2-domain-broadcasting-examples" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Step 2: Domain Broadcasting Examples<a href="#md:step-2-domain-broadcasting-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Let's also create a dedicated example that shows different domain broadcasting patterns in <code>examples/domain-broadcasting-demo.ts</code>:</p>
<pre><code class="typescript"><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">createArvoEventFactory</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">userRegistrationContract</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../contracts/user-registration&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">userRegistrationHandlerFactory</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../handlers/user-registration-handler&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">UserDatabase</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;../services/database&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">async</span><span class="hl-1"> </span><span class="hl-6">function</span><span class="hl-1"> </span><span class="hl-0">runDomainBroadcastingDemo</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">database</span><span class="hl-1"> = </span><span class="hl-6">new</span><span class="hl-1"> </span><span class="hl-0">UserDatabase</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">handler</span><span class="hl-1"> = </span><span class="hl-0">userRegistrationHandlerFactory</span><span class="hl-1">({ </span><span class="hl-4">database</span><span class="hl-1"> });</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">eventFactory</span><span class="hl-1"> = </span><span class="hl-0">createArvoEventFactory</span><span class="hl-1">(</span><span class="hl-4">userRegistrationContract</span><span class="hl-1">.</span><span class="hl-0">version</span><span class="hl-1">(</span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-1">));</span><br/><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;=== Domain Broadcasting Demo ===</span><span class="hl-11">\n</span><span class="hl-2">&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Test 1: Premium user registration (multiple domains)</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;üìù Test 1: Premium user registration&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">premiumEvent</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.web.frontend&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;john.doe@premium.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;johndoe&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;securepassword123&#39;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">premiumResult</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">premiumEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`‚úÖ Generated </span><span class="hl-6">${</span><span class="hl-4">premiumResult</span><span class="hl-10">.</span><span class="hl-4">events</span><span class="hl-10">.</span><span class="hl-4">length</span><span class="hl-6">}</span><span class="hl-2"> events for premium user:`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">premiumResult</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">index</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`   Event </span><span class="hl-6">${</span><span class="hl-4">index</span><span class="hl-10"> </span><span class="hl-1">+</span><span class="hl-10"> </span><span class="hl-8">1</span><span class="hl-6">}</span><span class="hl-2">: type=</span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">type</span><span class="hl-6">}</span><span class="hl-2">, domain=</span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">domain</span><span class="hl-10"> </span><span class="hl-1">||</span><span class="hl-10"> </span><span class="hl-2">&#39;null&#39;</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Test 2: Regular user registration (different domain pattern)</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;üìù Test 2: Regular user registration&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">regularEvent</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.web.frontend&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;jane.smith@gmail.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;janesmith&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;anotherpassword123&#39;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">regularResult</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">regularEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`‚úÖ Generated </span><span class="hl-6">${</span><span class="hl-4">regularResult</span><span class="hl-10">.</span><span class="hl-4">events</span><span class="hl-10">.</span><span class="hl-4">length</span><span class="hl-6">}</span><span class="hl-2"> events for regular user:`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">regularResult</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">index</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`   Event </span><span class="hl-6">${</span><span class="hl-4">index</span><span class="hl-10"> </span><span class="hl-1">+</span><span class="hl-10"> </span><span class="hl-8">1</span><span class="hl-6">}</span><span class="hl-2">: type=</span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">type</span><span class="hl-6">}</span><span class="hl-2">, domain=</span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">domain</span><span class="hl-10"> </span><span class="hl-1">||</span><span class="hl-10"> </span><span class="hl-2">&#39;null&#39;</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Test 3: Email conflict (error broadcasting)</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;üìù Test 3: Email conflict with domain broadcasting&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">conflictEvent</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.web.frontend&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;john.doe@premium.com&#39;</span><span class="hl-1">, </span><span class="hl-5">// Same as first test</span><br/><span class="hl-1">            </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;anotherjohn&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;conflictpassword123&#39;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">conflictResult</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">conflictEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`‚ùå Generated </span><span class="hl-6">${</span><span class="hl-4">conflictResult</span><span class="hl-10">.</span><span class="hl-4">events</span><span class="hl-10">.</span><span class="hl-4">length</span><span class="hl-6">}</span><span class="hl-2"> error events:`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">conflictResult</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">index</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`   Event </span><span class="hl-6">${</span><span class="hl-4">index</span><span class="hl-10"> </span><span class="hl-1">+</span><span class="hl-10"> </span><span class="hl-8">1</span><span class="hl-6">}</span><span class="hl-2">: type=</span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">type</span><span class="hl-6">}</span><span class="hl-2">, domain=</span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">domain</span><span class="hl-10"> </span><span class="hl-1">||</span><span class="hl-10"> </span><span class="hl-2">&#39;null&#39;</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`   Error: </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">error_code</span><span class="hl-6">}</span><span class="hl-2"> - </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">reason</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">// Test 4: Username conflict (single domain error)</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;üìù Test 4: Username conflict with single domain&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">usernameConflictEvent</span><span class="hl-1"> = </span><span class="hl-4">eventFactory</span><span class="hl-1">.</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.web.frontend&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-4">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">email:</span><span class="hl-1"> </span><span class="hl-2">&#39;unique.email@example.com&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-4">username:</span><span class="hl-1"> </span><span class="hl-2">&#39;johndoe&#39;</span><span class="hl-1">, </span><span class="hl-5">// Same as first test</span><br/><span class="hl-1">            </span><span class="hl-4">password:</span><span class="hl-1"> </span><span class="hl-2">&#39;uniquepassword123&#39;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">usernameConflictResult</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">usernameConflictEvent</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`‚ùå Generated </span><span class="hl-6">${</span><span class="hl-4">usernameConflictResult</span><span class="hl-10">.</span><span class="hl-4">events</span><span class="hl-10">.</span><span class="hl-4">length</span><span class="hl-6">}</span><span class="hl-2"> error event:`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-4">usernameConflictResult</span><span class="hl-1">.</span><span class="hl-4">events</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">((</span><span class="hl-4">event</span><span class="hl-1">, </span><span class="hl-4">index</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`   Event </span><span class="hl-6">${</span><span class="hl-4">index</span><span class="hl-10"> </span><span class="hl-1">+</span><span class="hl-10"> </span><span class="hl-8">1</span><span class="hl-6">}</span><span class="hl-2">: type=</span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">type</span><span class="hl-6">}</span><span class="hl-2">, domain=</span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">domain</span><span class="hl-10"> </span><span class="hl-1">||</span><span class="hl-10"> </span><span class="hl-2">&#39;null&#39;</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`   Error: </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">error_code</span><span class="hl-6">}</span><span class="hl-2"> - </span><span class="hl-6">${</span><span class="hl-4">event</span><span class="hl-10">.</span><span class="hl-4">data</span><span class="hl-10">.</span><span class="hl-4">reason</span><span class="hl-6">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-5">// Run the demo</span><br/><span class="hl-0">runDomainBroadcastingDemo</span><span class="hl-1">().</span><span class="hl-0">catch</span><span class="hl-1">(</span><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-4">error</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="md:understanding-domain-broadcasting-patterns" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Understanding Domain Broadcasting Patterns<a href="#md:understanding-domain-broadcasting-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>When you run this example (<code>npx tsx examples/domain-broadcasting-demo.ts</code>), you'll see different domain broadcasting patterns in action:</p>
<p><strong>Premium User Success Event</strong> creates 4 events:</p>
<ul>
<li><code>domain: 'analytics.users'</code> - For user analytics processing</li>
<li><code>domain: 'crm.premium'</code> - For premium customer relationship management</li>
<li><code>domain: 'marketing.vip'</code> - For VIP marketing campaigns</li>
<li><code>domain: null</code> - For standard processing pipeline</li>
</ul>
<p><strong>Regular User Success Event</strong> creates 3 events:</p>
<ul>
<li><code>domain: 'analytics.users'</code> - For user analytics processing</li>
<li><code>domain: null</code> - From <code>undefined</code> resolution (since no event or handler domain)</li>
<li><code>domain: null</code> - Explicit null domain (deduplication removes duplicate)</li>
</ul>
<p><strong>Email Conflict Error</strong> creates 3 events:</p>
<ul>
<li><code>domain: 'audit.failures'</code> - For failure auditing</li>
<li><code>domain: 'analytics.errors'</code> - For error analytics</li>
<li><code>domain: null</code> - For standard error processing</li>
</ul>
<p><strong>Username Conflict Error</strong> creates 1 event:</p>
<ul>
<li><code>domain: 'audit.failures'</code> - Single targeted domain for audit</li>
</ul>
<p>This demonstrates how domain broadcasting enables sophisticated event routing based on business logic, user types, and error conditions while maintaining clean separation of processing contexts.</p>
<a id="md:error-broadcasting" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Error Broadcasting<a href="#md:error-broadcasting" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>System errors are automatically broadcast to all relevant processing contexts:</p>
<ul>
<li>Source event domain (<code>event.domain</code>)</li>
<li>Handler contract domain (<code>handler.contract.domain</code>)</li>
<li>No-domain context (<code>null</code>)</li>
</ul>
<p>Duplicates are automatically removed, so if <code>event.domain === handler.contract.domain</code>, only two error events are created instead of three.</p>
<a id="md:event-handler-scaling" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Event Handler Scaling<a href="#md:event-handler-scaling" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>ArvoEventHandler</code> execution model implements a functional architecture that inherently supports scalability in distributed systems. At its core, each handler is a pure function with the signature <code>ArvoEvent =&gt; Promise&lt;{ events:ArvoEvent[] }&gt;</code>, encapsulating all processing logic within a self-contained unit. This fundamental design choice enables handlers to operate independently, receiving all required context through event parameters and maintaining consistent behavior across different deployment environments.</p>
<p>The contract-based validation system ensures behavioral consistency regardless of where handlers execute, while the absence of shared state eliminates traditional scaling bottlenecks. This architectural approach provides natural support for both horizontal scaling through distribution across multiple compute nodes, and vertical scaling through resource allocation. The handlers maintain their operational integrity whether deployed in traditional cluster environments, container orchestration platforms, or serverless infrastructures.</p>
<p>This architecture allows development teams to concentrate on implementing business logic without being constrained by scaling considerations. Handlers written and tested in development environments can transition directly to handling production workloads across distributed instances. The event-driven communication model enables flexible deployment strategies - systems can begin as modular monolithic applications and evolve into distributed architectures by introducing message brokers. Service communication remains event-based throughout, with the broker implementation ranging from an in-memory array for simple scenarios to external message brokers for production deployments. Event coordination between services can be managed through either choreography patterns or using the ArvoOrchestrator implementation provided by the <code>arvo-xstate</code> package, offering flexibility in system design and evolution.</p>
<a id="md:testing-event-handlers-in-arvo" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Testing Event Handlers in Arvo<a href="#md:testing-event-handlers-in-arvo" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Testing event handlers is a critical part of building reliable event-driven systems with Arvo. It provides several features that make testing handlers straightforward and effective.</p>
<a id="md:the-eventhandlerfactory-pattern" class="tsd-anchor"></a><h3 class="tsd-anchor-link">The <code>EventHandlerFactory</code> Pattern<a href="#md:the-eventhandlerfactory-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>EventHandlerFactory</code> is a function that creates an event handler. It takes the handler's dependencies as parameters, allowing them to be easily mocked or substituted in tests. This is a form of dependency injection.</p>
<pre><code class="typescript"><span class="hl-6">interface</span><span class="hl-1"> </span><span class="hl-9">HandlerDependencies</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">database</span><span class="hl-1">: </span><span class="hl-9">DatabaseClient</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-4">logger</span><span class="hl-1">: </span><span class="hl-9">Logger</span><span class="hl-1">;</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-0">userHandlerFactory</span><span class="hl-1">: </span><span class="hl-9">EventHandlerFactory</span><span class="hl-1">&lt;</span><span class="hl-9">HandlerDependencies</span><span class="hl-1">&gt; = ({</span><br/><span class="hl-1">  </span><span class="hl-4">database</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">logger</span><br/><span class="hl-1">}) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-5">// Handler configuration...</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>In tests, you can provide mocked versions of the dependencies:</p>
<pre><code class="typescript"><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">mockedDatabase</span><span class="hl-1"> = </span><span class="hl-0">createMockDatabase</span><span class="hl-1">();</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">mockedLogger</span><span class="hl-1"> = </span><span class="hl-0">createMockLogger</span><span class="hl-1">();</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">handler</span><span class="hl-1"> = </span><span class="hl-0">userHandlerFactory</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-4">database:</span><span class="hl-1"> </span><span class="hl-4">mockedDatabase</span><span class="hl-1">, </span><br/><span class="hl-1">  </span><span class="hl-4">logger:</span><span class="hl-1"> </span><span class="hl-4">mockedLogger</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>This allows you to test the handler in isolation, controlling its dependencies and asserting on how it interacts with them.</p>
<a id="md:consistent-handler-signature" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Consistent Handler Signature<a href="#md:consistent-handler-signature" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>All Arvo event handlers have the same basic signature:</p>
<pre><code><span class="hl-4">ArvoEvent</span><span class="hl-1"> </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-9">Promise</span><span class="hl-1">&lt;{ </span><span class="hl-12">events</span><span class="hl-1">:</span><span class="hl-4">ArvoEvent</span><span class="hl-1">[] }&gt;</span>
</code><button>Copy</button></pre>

<p>They take an <code>ArvoEvent</code> as input and return a <code>Promise</code> that resolves to an array of <code>ArvoEvent</code>s. This consistency makes it easy to write tests for any handler.</p>
<p>A typical test would:</p>
<ol>
<li>Create an input <code>ArvoEvent</code></li>
<li>Pass it to the handler's <code>execute</code> method</li>
<li>Assert on the output events</li>
</ol>
<pre><code class="typescript"><span class="hl-0">it</span><span class="hl-1">(</span><span class="hl-2">&#39;should create a user successfully&#39;</span><span class="hl-1">, </span><span class="hl-6">async</span><span class="hl-1"> () </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">userCreatedEvent</span><span class="hl-1"> = </span><span class="hl-0">createArvoEventFactory</span><span class="hl-1">(</span><br/><span class="hl-1">	  </span><span class="hl-4">userCreateContract</span><span class="hl-1">.</span><span class="hl-0">version</span><span class="hl-1">(</span><span class="hl-2">&#39;1.0.0&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  ).</span><span class="hl-0">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">subject:</span><span class="hl-1"> </span><span class="hl-2">&#39;test-subject&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">source:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.test.test&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">data:</span><span class="hl-1"> { </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;John Doe&#39;</span><span class="hl-1"> }</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">outputEvents</span><span class="hl-1"> = </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">userCreatedEvent</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">outputEvents</span><span class="hl-1">).</span><span class="hl-0">toHaveLength</span><span class="hl-1">(</span><span class="hl-8">1</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">outputEvents</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">type</span><span class="hl-1">).</span><span class="hl-0">toBe</span><span class="hl-1">(</span><span class="hl-2">&#39;evt.user.created&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">outputEvents</span><span class="hl-1">[</span><span class="hl-8">0</span><span class="hl-1">].</span><span class="hl-4">data</span><span class="hl-1">.</span><span class="hl-4">userId</span><span class="hl-1">).</span><span class="hl-0">toBeDefined</span><span class="hl-1">();</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<a id="md:contract-based-validation" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Contract-Based Validation<a href="#md:contract-based-validation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Arvo handlers are bound to an <code>ArvoContract</code> that specifies the events they can accept and emit. This contract is automatically validated at runtime.</p>
<p>If a handler tries to emit an event that doesn't conform to its contract, Arvo will throw a <code>ContractViolation</code> error. You can test this behavior directly:</p>
<pre><code class="typescript"><span class="hl-0">it</span><span class="hl-1">(</span><span class="hl-2">&#39;should throw ContractViolation if emitting invalid event&#39;</span><span class="hl-1">, </span><span class="hl-6">async</span><span class="hl-1"> () </span><span class="hl-6">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-7">inputEvent</span><span class="hl-1"> = </span><span class="hl-0">createArvoEvent</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-4">type:</span><span class="hl-1"> </span><span class="hl-2">&#39;com.user.create&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">data:</span><span class="hl-1"> { </span><span class="hl-4">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;John Doe&#39;</span><span class="hl-1"> }</span><br/><span class="hl-1">    ...</span><span class="hl-4">rest</span><span class="hl-1">,</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-3">await</span><span class="hl-1"> </span><span class="hl-0">expect</span><span class="hl-1">(</span><span class="hl-4">handler</span><span class="hl-1">.</span><span class="hl-0">execute</span><span class="hl-1">(</span><span class="hl-4">inputEvent</span><span class="hl-1">)).</span><span class="hl-4">rejects</span><span class="hl-1">.</span><span class="hl-0">toThrow</span><span class="hl-1">(</span><span class="hl-4">ContractViolation</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>This test ensures that the handler adheres to its contract, providing an additional layer of safety and testability.</p>
<a id="md:integration-testing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Integration Testing<a href="#md:integration-testing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Arvo's contract-based design and use of the <code>ArvoEventFactory</code> pattern enable robust integration testing without needing to write extensive test code. The <code>ArvoContract</code> serves as a single source of truth that all services share, providing a clear specification of each service's expected behavior and interactions. Since inter-service communication must strictly adhere to the contract via <code>ArvoEvent</code>s, integration testing becomes more focused on verifying that events flow correctly through the system as a whole, rather than exhaustively testing every possible interaction between services. This contract-driven approach catches many potential integration issues at the contract level, reducing the surface area that needs to be covered by traditional integration tests. As a result, integration testing in Arvo can concentrate on high-level event flows and key scenarios, confident that the contract enforcement will maintain the agreed-upon interfaces between services.</p>
<a id="md:conclusion" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Conclusion<a href="#md:conclusion" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Arvo is a TypeScript framework designed to make building reliable, evolvable event-driven systems easier. It does this through:</p>
<ol>
<li><strong>Contract-first development</strong>: Service interfaces are defined upfront in ArvoContracts. These aren't just documentation, but are actively enforced in the code.</li>
<li><strong>Strong typing</strong>: Leveraging TypeScript allows for compile-time checks of event payloads against the contracts.</li>
<li><strong>Versioned contracts</strong>: Each version of a contract is treated as an independent interface. This allows services to evolve without breaking consumers.</li>
<li><strong>EventHandlerFactory pattern</strong>: A consistent way to create event handlers, injecting dependencies. Enables easier testing.</li>
<li><strong>Built-in error handling</strong>: Errors are automatically converted to system events or thrown as violations. Reduces boilerplate.</li>
<li><strong>Observability</strong>: Integration with OpenTelemetry for tracing and logToSpan utility for logging. Visibility into complex flows.</li>
<li><strong>Scalability</strong>: The functional handler design (ArvoEvent in, array of ArvoEvents out) allows horizontal and vertical scaling.</li>
</ol>
<p>The key idea is that by making service contracts first-class citizens and providing a structured way to create and evolve event-driven services, Arvo helps tame the complexity inherent in distributed systems development. While it makes trade-offs (like the additional code for versioned handlers), these are designed to prioritise maintainability and reliability over raw conciseness.</p>
<p>Of course, Arvo isn't a silver bullet - it's one opinionated approach to the challenges of event-driven architectures. But by learning from the history of SOA and more recent serverless trends, it attempts to provide a pragmatic, TypeScript-native framework for building the next generation of evolvable systems.</p>
<a id="md:appendix" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Appendix<a href="#md:appendix" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>For an indepth view of the functioning and execution of the ArvoEventHandler, please refer to the <a href="https://github.com/SaadAhmad123/arvo-event-handler/blob/main/src/ArvoEventHandler/ExecutionDiagrams.md" target="_blank" class="external">exection diagrams</a> of the <code>.execute</code> method.</li>
<li>Reade more about the <code>ArvoContract</code> in the <code>arvo-core</code> <a href="https://saadahmad123.github.io/arvo-core/documents/ArvoContract.html" target="_blank" class="external">documentation</a>.</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:arvoeventhandler---implementation-of-a-reliable-event-driven-system"><span>Arvo<wbr/>Event<wbr/>Handler -<wbr/> <wbr/>Implementation of a <wbr/>Reliable <wbr/>Event-<wbr/>Driven <wbr/>System</span></a><a href="#md:getting-started-with-arvoeventhandler"><span>Getting <wbr/>Started with <wbr/>Arvo<wbr/>Event<wbr/>Handler</span></a><ul><li><a href="#md:your-first-event-handler"><span>Your <wbr/>First <wbr/>Event <wbr/>Handler</span></a></li><li><ul><li><a href="#md:step-1-set-up-your-contract-and-dependencies"><span>Step 1: <wbr/>Set <wbr/>Up <wbr/>Your <wbr/>Contract and <wbr/>Dependencies</span></a></li><li><a href="#md:step-2-create-your-event-handler"><span>Step 2: <wbr/>Create <wbr/>Your <wbr/>Event <wbr/>Handler</span></a></li><li><a href="#md:step-3-put-it-all-together"><span>Step 3: <wbr/>Put <wbr/>It <wbr/>All <wbr/>Together</span></a></li><li><a href="#md:step-4-run-your-service"><span>Step 4: <wbr/>Run <wbr/>Your <wbr/>Service</span></a></li></ul></li><li><a href="#md:advanced-patterns"><span>Advanced <wbr/>Patterns</span></a></li><li><ul><li><a href="#md:handling-multiple-versions"><span>Handling <wbr/>Multiple <wbr/>Versions</span></a></li><li><a href="#md:error-handling-strategy"><span>Error <wbr/>Handling <wbr/>Strategy</span></a></li><li><a href="#md:testing-your-handler"><span>Testing <wbr/>Your <wbr/>Handler</span></a></li></ul></li><li><a href="#md:whats-next"><span>What&#39;s <wbr/>Next?</span></a></li><li><a href="#md:principles-of-reliable-event-driven-systems"><span>Principles of <wbr/>Reliable <wbr/>Event-<wbr/>Driven <wbr/>Systems</span></a></li><li><a href="#md:contract-first-development-in-typescript"><span>Contract-<wbr/>First <wbr/>Development in <wbr/>Type<wbr/>Script</span></a></li><li><a href="#md:implementing-your-first-arvo-service"><span>Implementing <wbr/>Your <wbr/>First <wbr/>Arvo <wbr/>Service</span></a></li><li><ul><li><a href="#md:the-factory-pattern---eventhandlerfactory"><span>The factory pattern -<wbr/> <wbr/>Event<wbr/>Handler<wbr/>Factory</span></a></li><li><a href="#md:anatomy-of-a-handler-function"><span>Anatomy of a handler function</span></a></li><li><a href="#md:logging-mechanism"><span>Logging <wbr/>Mechanism</span></a></li></ul></li><li><a href="#md:managing-service-evolution-through-contracts"><span>Managing <wbr/>Service <wbr/>Evolution <wbr/>Through <wbr/>Contracts</span></a></li><li><a href="#md:event-processing-and-execution-flow"><span>Event <wbr/>Processing and <wbr/>Execution <wbr/>Flow</span></a></li><li><ul><li><a href="#md:what-happens-here"><span>What <wbr/>Happens <wbr/>Here?</span></a></li><li><a href="#md:understanding-the-handler-interface"><span>Understanding the <wbr/>Handler <wbr/>Interface</span></a></li></ul></li><li><a href="#md:error-handling"><span>Error <wbr/>Handling</span></a></li><li><ul><li><a href="#md:system-error-events"><span>System <wbr/>Error <wbr/>Events</span></a></li><li><a href="#md:violations"><span>Violations</span></a></li><li><ul><li><a href="#md:configviolation"><span>Config<wbr/>Violation</span></a></li><li><a href="#md:contractviolation"><span>Contract<wbr/>Violation</span></a></li><li><a href="#md:executionviolation"><span>Execution<wbr/>Violation</span></a></li></ul></li></ul></li><li><a href="#md:a-note-on-contract-validation-performance"><span>A <wbr/>Note on <wbr/>Contract <wbr/>Validation <wbr/>Performance</span></a></li><li><a href="#md:multi-domain-event-broadcasting"><span>Multi-<wbr/>Domain <wbr/>Event <wbr/>Broadcasting</span></a></li><li><ul><li><a href="#md:understanding-domains"><span>Understanding <wbr/>Domains</span></a></li><li><a href="#md:domain-assignment-rules"><span>Domain <wbr/>Assignment <wbr/>Rules</span></a></li><li><a href="#md:domain-broadcasting-pattern"><span>Domain broadcasting pattern</span></a></li><li><ul><li><a href="#md:step-1-update-your-event-handler"><span>Step 1: <wbr/>Update <wbr/>Your <wbr/>Event <wbr/>Handler</span></a></li><li><a href="#md:step-2-domain-broadcasting-examples"><span>Step 2: <wbr/>Domain <wbr/>Broadcasting <wbr/>Examples</span></a></li><li><a href="#md:understanding-domain-broadcasting-patterns"><span>Understanding <wbr/>Domain <wbr/>Broadcasting <wbr/>Patterns</span></a></li></ul></li><li><a href="#md:error-broadcasting"><span>Error <wbr/>Broadcasting</span></a></li></ul></li><li><a href="#md:event-handler-scaling"><span>Event <wbr/>Handler <wbr/>Scaling</span></a></li><li><a href="#md:testing-event-handlers-in-arvo"><span>Testing <wbr/>Event <wbr/>Handlers in <wbr/>Arvo</span></a></li><li><ul><li><a href="#md:the-eventhandlerfactory-pattern"><span>The <wbr/>Event<wbr/>Handler<wbr/>Factory <wbr/>Pattern</span></a></li><li><a href="#md:consistent-handler-signature"><span>Consistent <wbr/>Handler <wbr/>Signature</span></a></li><li><a href="#md:contract-based-validation"><span>Contract-<wbr/>Based <wbr/>Validation</span></a></li><li><a href="#md:integration-testing"><span>Integration <wbr/>Testing</span></a></li></ul></li><li><a href="#md:conclusion"><span>Conclusion</span></a></li><li><a href="#md:appendix"><span>Appendix</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../modules.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-1"></use></svg><span>arvo-event-handler</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base=".."><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a> with <a href="https://github.com/KillerJulian/typedoc-github-theme" target="_blank">typedoc-github-theme</a></p></footer><div class="overlay"></div></body></html>
